<img src="{{ bubble.photourl }}" id="person_photo" />
<div id="open_document_box" class="dropdown">
    <a href="javascript:void(0);" class="iconic x-alt simplemodal-close" title="{{ str.open_document }}" style="float:right;"></a>
    <h2>{{ str.open_document }}</h2>
    <a href="/bubble/d1/{{ bubble.key.id }}" target="_blank">{{ str.bubble_doc_gradesheet }}</a><br />
    <a href="/person/csv?bubble_leechers={{ bubble.key }}">{{ str.bubble_doc_leechers_csv }}</a>
</div>

<h1>{{ bubble.displayname }}</h1>
<section class="table">
    {% for t in bubble.tags %}
    {% if t.value %}{% ifequal t.data_property "name" %}
    {% else %}
    <div class="row">
        <div class="v_header">
            {{ t.name }}
        </div>
        <div class="cell">
            {{ t.value|join:"<br />"|urlize|linebreaks }}
        </div>
    </div>
    {% endifequal %}{% endif %}
    {% endfor %}
</section>

<section class="info_accordion">
    <div style="display:none;">
        <h2>{{ str.bubble_seeders }}<span><img src="/images/spinner_gray_small.gif" /></span></h2>
        <div id="seeders" class="persons_list"></div>
    </div>
    <div style="display:none;">
        <h2>{{ str.bubble_leechers }}<span><img src="/images/spinner_gray_small.gif" /></span></h2>
        <div id="leechers" class="persons_list"></div>
    </div>
    <div style="display:none;">
        <h2>{{ str.bubble_waitinglist }}<span><img src="/images/spinner_gray_small.gif" /></span></h2>
        <div id="waitinglist" class="persons_list"></div>
    </div>
    <div style="display:none;">
        <h2>{{ str.bubble_subbubbles }}<span><img src="/images/spinner_gray_small.gif" /></span></h2>
        <div id="subbubbles" class="subbubbles_list"></div>
    </div>
</section>

<script type="text/javascript">
    $(document).ready(function(){

        $('.info_accordion div h2').click(function() {
            $(this).next().slideToggle();
        });

        tools = [
            '<a id="open_new" href="javascript:void(0);" class="icon write" title="{{ str.bubble_add_new }}"></a>',
            '<a id="open_edit" href="javascript:void(0);" class="icon pencil" title="{{ str.bubble_edit }}"></a>',
            '<a id="open_document" href="javascript:void(0);" class="icon printer space" title="{{ str.open_document }}"></a>',
        ];
        $('#tools').html(tools.join(''));

        $('#open_edit').click(function() {
            $.get('/bubble/edit/{{ bubble.key.id }}', function(data) {
                $("#list_content div").html(data);
                $('#tools').html('');
            });
        });


        $('#open_document').click(function() {
            $("#open_document_box").modal({
	            position: [0,50],
	            opacity: 20,
                overlayCss: {backgroundColor:"#000000"},
                escClose: true,
                overlayClose: true,
            });
        });

        $('#close_open_document_box').click(function() {
            $("#open_document_box").slideUp();
        });

        ajax_persons_list('/person', { bubble_seeders: '{{ bubble.key }}' }, $('#seeders'), 'seeder');
        ajax_persons_list('/person', { bubble_leechers: '{{ bubble.key }}' }, $('#leechers'), 'leecher');
        ajax_persons_list('/person', { bubble_waitinglist: '{{ bubble.key }}' }, $('#waitinglist'), 'waitinglist');
        ajax_bubbles_list('/bubble', { master_bubble: '{{ bubble.key }}' }, $('#subbubbles'), 'subbubbles');

        function ajax_persons_list(post_url, post_data, div, id) {
            $.post(post_url, post_data, function(list) {
                for (i in list.keys) {
                    div.append('<a href="#" id="'+id+'_'+list.keys[i]+'"></a>');
                    $.post(post_url, {key: list.keys[i]}, function(item) {
                        if(item.image) {
                            image = '<img src="'+item.image+'" />';
                        } else {
                            image = '';
                        }
                        if(item.info) {
                            info = '<span>'+item.info+'</span>';
                        } else {
                            info = '';
                        }
                        if('#'+item.id == window.location.hash) {
                            active = 'class="active" ';
                        } else {
                            active = '';
                        }
                        $('#'+id+'_'+item.key).html(image+item.title);
                        $('#'+id+'_'+item.key).attr('href', '/person#'+item.id);
                    }, 'json');
                }
                if (list.keys.length > 0) {
                    div.parent().show();
                    div.parent().children('h2').children('span').html(list.keys.length);
                } else {
                    div.parent().hide();
                }
            }, 'json');
        }

        function ajax_bubbles_list(post_url, post_data, div, id) {
            $.post(post_url, post_data, function(list) {
                for (i in list.keys) {
                    div.append('<a href="#" id="'+id+'_'+list.keys[i]+'">&nbsp;</a>');
                    $.post(post_url, {key: list.keys[i]}, function(item) {
                        if(item.info) {
                            info = '<span>'+item.info+'</span>';
                        } else {
                            info = '';
                        }
                        if('#'+item.id == window.location.hash) {
                            active = 'class="active" ';
                        } else {
                            active = '';
                        }
                        $('#'+id+'_'+item.key).html(item.type_name+' - '+item.title+'<span>'+item.info+'</span>');
                        $('#'+id+'_'+item.key).attr('href', '/bubble/'+item.type+'#'+item.id);
                    }, 'json');
                }
                if (list.keys.length > 0) {
                    div.parent().show();
                    div.parent().children('h2').children('span').html(list.keys.length);
                } else {
                    div.parent().hide();
                }
            }, 'json');
        }

    });
</script>
