<img src="{{ bubble.photourl }}" id="person_photo" />
<div id="edit_bubble_box" class="dropdown" style="padding:0px;">
    <img src="/images/spinner_gray_small.gif" class="spinner" />
    <div id="edit_bubble_box_content" style="padding:10px;"></div>
</div>

<h1>{{ bubble.displayname }}</h1>
<section class="table">
    {% for t in bubble.GetProperties %}
    {% if t.has_values %}{% if t.data_property != "name" %}
    <div class="row">
        <div class="v_header">
            {{ t.name }}
        </div>
        <div class="cell">
            {% for v in t.values %}
                {% if v.value %}
                    {% if t.data_type == "blobstore" %}
                        <a href="/bubble/file/{{ t.data_property }}/{{ v.key }}">{{ v.value|linebreaks }}</a>
                    {% else %}
                        {{ v.value|safe|urlize|linebreaks }}
                    {% endif %}
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}{% endif %}
    {% endfor %}
</section>

<div id="tiptip_holder" style="max-width: 200px; margin-right: 0px; margin-bottom: 0px;" class="tip_bottom">
    <div id="tiptip_arrow" style="margin-left: 20px; margin-top: -12px; ">
        <div id="tiptip_arrow_inner"></div>
    </div>
    <div id="tiptip_content">
        {% for t in bubble.GetAllowedSubtypes %}
        <a href="javascript:void(0);" class="add_new_subbubble" data-type="{{ t.key }}">{{ t.displayname }}</a><br />
        {% endfor %}
    </div>
</div>

<section class="info_accordion">
    <div style="display:none;">
        <h2>{{ str.bubble_leecher }}<span><img src="/images/spinner_gray_small.gif" /></span></h2>
        <div id="leecher" class="subbubbles_list"></div>
    </div>
    <div style="display:none;">
        <h2>{{ str.bubble_leechers }}<span><img src="/images/spinner_gray_small.gif" /></span></h2>
        <div id="leechers" class="subbubbles_list"></div>
    </div>
    {% for t in bubbletypes %}
    <div style="display:none;">
        <h2>{{ t.displayname }}<span><img src="/images/spinner_gray_small.gif" /></span></h2>
        <div class="subbubbles_list subbubbles" data-type="{{ t.path }}"></div>
    </div>
    {% endfor %}
</section>

<script type="text/javascript">
    $(document).ready(function(){

        document.title = '{{ site_name }}';

        $('.info_accordion div h2').click(function() {
            $(this).next().slideToggle();
        });

        tools = [
            {% if bubble.GetAllowedSubtypes %}'<a id="open_new_tipmenu" href="javascript:void(0);" class="icon add" title="{{ str.bubble_add_new }}"></a>',{% endif %}
            '<a id="open_edit" href="javascript:void(0);" class="icon pencil tiptip" title="{{ str.bubble_edit }}"></a>',
        ];
        $('#tools').html(tools.join(''));

        $("#open_new_tipmenu").click(function() {
            tiptip = $('#tiptip_holder');
            button = $(this);
            tiptip.left = button.left+(button.width/2)-(tiptip.width/2);
            tiptip.top = button.top+button.height;
            tiptip.show();
        });

        $("#tiptip_holder").mouseleave(function() {
            $(this).hide();
        });

        $('.add_new_subbubble').click(function() {
            $("#tiptip_holder").hide();
            $.post('/bubble/add/{{ bubble.key.id }}', {type: $(this).data('type')}, function(bubble_id) {
                open_edit(bubble_id);
            });
        });

        $('#open_edit').click(function() {
            open_edit('{{ bubble.key.id }}');
        });

        function open_edit(bubble_id) {
            $('#edit_bubble_box_content').html('');
            $('#edit_bubble_box .spinner').show();
            $("#edit_bubble_box").modal({
                position: [0,50],
                opacity: 30,
                overlayCss: {backgroundColor:"#000000"},
                escClose: true,
                overlayClose: true,
                onClose: reload_item,
            });
            $.get('/bubble/edit/'+bubble_id, function(data) {
                $('#edit_bubble_box .spinner').hide();
                $("#edit_bubble_box_content").html(data);
                if($('#edit_bubble_box_content').height() > $(window).height()*0.9) {
                    $('#edit_bubble_box_content').css('overflow-x', 'hidden');
                    $('#edit_bubble_box_content').css('overflow-y', 'auto');
                    $('#edit_bubble_box_content').css('max-height', $(window).height()*0.9);
                };
            });
        };

        $('#close_open_document_box').click(function() {
            $("#open_document_box").slideUp();
        });

        ajax_bubbles_list('/bubble/', { type: 'leecher_in', value: '{{ bubble.key }}' }, $('#leecher'), 'leecher');
        ajax_bubbles_list('/bubble/', { type: 'leecher', value: '{{ bubble.key }}' }, $('#leechers'), 'leechers');

        $('.subbubbles').each(function() {
            ajax_bubbles_list('/bubble/'+$(this).data('type'), { type: 'subbubbles', value: '{{ bubble.key }}' }, $(this), 'subbubbles');
        });

        $('.open_subbubble').live('click', function() {
            id = $(this).attr('href').substring(1)
            open_item(id);
            $('#list_items a.active').removeClass('active');
            $('#list_items a[href$="#'+id+'"]').addClass('active');
        });

        function reload_item() {
            $.modal.close();
            open_item({{ bubble.key.id }})
        }

        function open_item(id) {
            $('#list_content .spinner').show();
            $('#list_content div').html('');
            $.get('/bubble/show/'+id, function(html) {
                $('#list_content .spinner').hide();
                $('#list_content div').html(html);
            });
        }

        function ajax_bubbles_list(post_url, post_data, div, id) {
            $.post(post_url, post_data, function(list) {
                for (i in list.keys) {
                    div.append('<a href="#" id="'+id+'_'+list.keys[i]+'">&nbsp;</a>');
                    $.post(post_url, {key: list.keys[i]}, function(item) {
                        if(item.info) {
                            info = '<span>'+item.info+'</span>';
                        } else {
                            info = '';
                        }
                        if('#'+item.id == window.location.hash) {
                            active = 'class="active" ';
                        } else {
                            active = '';
                        }
                        $('#'+id+'_'+item.key).html(item.title+'<span>'+item.info+'</span>');
                        if (item.type == '{{ bubble.type }}') {
                            $('#'+id+'_'+item.key).attr('href', '#'+item.id);
                            $('#'+id+'_'+item.key).addClass('open_subbubble');
                        } else {
                            $('#'+id+'_'+item.key).attr('href', '/bubble/'+item.type+'#'+item.id);
                        }
                    }, 'json');
                }
                if (list.keys.length > 0) {
                    div.parent().show();
                    div.parent().children('h2').children('span').html(list.keys.length);
                }
            }, 'json');
        }

    });
</script>
