<!DOCTYPE html>
<html>
<head>
  <title>S3</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
</head>
<body>
  <form action="/upload" method="post" enctype="multipart/form-data">
    <input type="file" id="fileupload" name="file" multiple>
  </form>
  <div id="progress"></div>
  <script type="text/javascript">
    $(document).ready(function () {

      $('input[type="file"]').change(function () {
        for (var i=0; i<this.files.length; i++) {
          uploadFile(this.files[i]);
        }
        $(this).val(null);
      });

      function uploadFile(file) {
        $.ajaxSetup({ cache: false });
        $.getJSON('https://dev.entu.ee/api2/s3upload', {file_name: file.name, file_size: file.size, file_type: file.type}, function (result) {
          var xhr = new XMLHttpRequest();
          var form = new FormData();

          for(var i in result.data) {
            form.append(i, result.data[i]);
          }
          form.append('file', file);
          console.log(file);

          var status = $('<p>'+file.name+' - <i>Uploading...</i></p>');
          $('form').append(status);
          xhr.upload.addEventListener('progress', function (ev) {
            if(ev.lengthComputable) {
              status.children('i').html(parseInt(ev.loaded * 100 / ev.total)+'%');
            }
          }, false);

          xhr.onreadystatechange = function(ev){
            if(xhr.readyState == 4 && xhr.status == 201){
              file = {
                location: $('Location', xhr.responseXML).text(),
                bucket: $('Bucket', xhr.responseXML).text(),
                key: $('Key', xhr.responseXML).text(),
                etag: $('ETag', xhr.responseXML).text(),
                message: $('Message', xhr.responseXML).text(),
              }
              $.getJSON('https://dev.entu.ee/api2/s3upload', file, function (result) {
                status.children('i').html('<a href="'+result.url+'">Done!</a>');
              });
            }
            if(xhr.readyState == 4 && xhr.status != 201){
              status.children('i').html('Error!');
            }
          };

          xhr.open('POST', result.url, true);
          xhr.send(form);
        });
      }
    });
  </script>
</body>
</html>
