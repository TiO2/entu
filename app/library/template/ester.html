<div class="row" style="text-align:center; margin-bottom:10px; margin-top:20px;">
    <div class="input-append">
        <input type="text" id="search-text" name="search" class="span4" placeholder="{{ _('action_add_ester_search_placeholder') }}" value="" data-intro="{{ _('action_add_ester_help_search') }}" data-position="bottom" /><button id="search-button" class="btn">{{ _('search_button') }}</button>
    </div>
</div>
<div class="row" style="text-align:center; margin-bottom:10px; margin-top:20px;">
    <img src="{{ static_url('images/spinner_white.gif') }}" id="search-spinner" style="padding:40px; display:none; " />
</div>
<table id="search-results" class="table" style="margin:0px 0px 50px 0px;">
</table>

<script>

    function importItem(file_id, parent_entity_id, entity_definition_keyname) {
        $('#modal-box').modal('hide');
        $('#modal-box').html('');
        $.post('/action/ester/import', {
            'file_id': file_id,
            'parent_entity_id': parent_entity_id,
            'entity_definition_keyname': entity_definition_keyname,
        },
        function(new_id) {
            window.location = '/entity/{{ entity_definition_keyname }}/'+new_id;
        });
    };

    function openItem(entity_definition_keyname, entity_id) {
        $('#modal-box').modal('hide');
        $('#modal-box').html('');
        window.location = '/entity/'+entity_definition_keyname+'/'+entity_id;
    };

    $(document).ready(function(){

        $('#search-text').focus();

        $("#search-text").keyup(function(event) {
            if(event.keyCode == 13){
                $("#search-button").click();
            }
        });

        $('#search-button').click(function() {
            if($('#search-text').val()) {
                $('#search-spinner').show();
                $('#search-results').hide();
                $('#search-results').html('');
                $.post('/action/ester/search', {
                        query: $('#search-text').val()
                    },
                    function(list) {
                		for (i in list.items) {
                            var item = list.items[i];
                            var tr = '<tr>';
                            if(item.entity_id) {
                                tr += '<td style="width:50px;"><img src="/photo-by-isbn?entity='+item.entity_id+'" style="width:50px; height:50px;" /></td>';
                            } else {
                                tr += '<td style="width:50px;"><img src="/photo-by-isbn?ester_file='+item.file_id+'" style="width:50px; height:50px;" /></td>';
                            }
                            tr += '<td>';
                            if(item.title) tr += '<b>'+item.title.join('<br />')+'</b><br />';
                            if(item.subtitle) tr += '<i>'+item.subtitle.join(', ')+'</i><br />';
                            if(item.author) tr += '<b>'+item.author.join(' / ')+'</b><br />';
                            if(item.year) tr += item.year.join(', ')+'<br />';
                            if(item.isbn) tr += '<i>'+item.isbn.join(', ')+'</i>';
                            tr += '</td>';
                            if(item.entity_id) {
                                tr += '<td><a href="javascript:openItem(\''+item.entity_definition_keyname+'\','+item.entity_id+');" class="btn btn-info pull-right">{{ _('action_add_ester_open') }}</a></td>';
                            } else {
                                tr += '<td><a href="javascript:importItem('+item.file_id+',{{ parent_entity_id }},\'{{ entity_definition_keyname }}\');" class="btn btn-success pull-right">{{ _('action_add_ester_add') }}</a></td>';
                            }
                            tr += '</tr>';
                            $('#search-results').append(tr);
                        };
                        $('#search-results').show();
                        $('#search-spinner').hide();
                }, 'json');
            } else {
                $('#search-text').focus();
            }

        });

    });
</script>
